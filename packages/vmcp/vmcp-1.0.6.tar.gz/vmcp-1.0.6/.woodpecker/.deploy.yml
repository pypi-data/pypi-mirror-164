# Deploy project
# SPDX-License-Identifier: AGPL-3.0-or-later

variables:
  - &python_image 'python:3.10.6'

pipeline:
  setup:
    image: *python_image
    commands:
      - git fetch --tags
      - echo $(git tag -l --format='%(subject)' $(git describe)) > TAG_MESSAGE.txt
    when:
      event: tag
      tag: v*

  build:
    image: *python_image
    commands:
      - pip install --upgrade build
      - python -m build
    when:
      event: tag
      tag: v*

  release:
    image: plugins/gitea-release
    settings:
      title: ${CI_COMMIT_TAG}
      note: TAG_MESSAGE.txt
      base_url: https://codeberg.org
      files: dist/*
      checksum: sha256
      api_key:
        from_secret: gitea_api_token
    when:
      event: tag
      tag: v*

  deploy:
    image: *python_image
    commands:
      - pip install --upgrade twine
      - python -m twine upload -u "__token__" -p "$PYPI_API_TOKEN" dist/*
    secrets: [
      pypi_api_token
    ]
    when:
      event: tag
      tag: v*
