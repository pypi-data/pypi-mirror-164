#!python

from Cinema.Prompt import Launcher, Visualiser
import matplotlib.pyplot as plt
import numpy as np
import argparse
from Cinema.Interface.Utils import findData
import os

parser = argparse.ArgumentParser()
parser.add_argument('-g', '--gdml', action='store', type=str, default='',
                    dest='gdml', help='input gdml file')
parser.add_argument('-v', '--visualize', action='store_true', dest='visualize', help='flag to visualize gdml model')
parser.add_argument('-s', '--seed', action='store', type=int, default=4096,
                    dest='seed', help='random seed number')
parser.add_argument('-n', '--neutronNum', action='store', type=float, default=100,
                    dest='neutronNum', help='neutron number')

args=parser.parse_args()
inputfile=args.gdml

if not os.path.isfile(inputfile):
    inputfile=findData(f'gdml/{inputfile}', '.')
    if not os.path.isfile(inputfile):
        raise IOError(f'The input GDML file {args.gdml} is not found.')

rdseed=args.seed

myLcher=Launcher()
myLcher.setSeed(rdseed)
myLcher.loadGeometry(inputfile)

if args.visualize is True:
    v = Visualiser(['Tube300', 'Tube500', '300_L', '500_L'], printWorld=True)
    for i in range(int(args.neutronNum)):
        print(f'trajectory size {myLcher.getTrajSize()}')
        myLcher.go(1, recordTrj=True)
        print(f'trajectory size {myLcher.getTrajSize()}')
        trj = myLcher.getTrajectory()
        try:
            v.addLine(trj)
        except ValueError:
            print("skip ValueError in File '/Prompt/scripts/promptpy', in <module>, v.addLine(trj)")
        print(trj)
    v.show()
else:
    myLcher.go(int(args.neutronNum), recordTrj=False)
