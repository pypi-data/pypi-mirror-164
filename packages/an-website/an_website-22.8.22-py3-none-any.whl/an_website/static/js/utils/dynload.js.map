{
  "version": 3,
  "sources": ["../../../utils/dynload.ts"],
  "sourcesContent": ["// @license magnet:?xt=urn:btih:0b31508aeb0634b347b8270c7bee4d411b5d4109&dn=agpl-3.0.txt GNU-AGPL-3.0-or-later\n\"use strict\";\nconst bodyDiv = elById(\"body\");\n\nconst lastLoaded = [];\nfunction dynLoadOnData(data, onpopstate) {\n    if (!data) {\n        error(\"No data received\");\n        return;\n    }\n    if (data[\"redirect\"]) {\n        w.location.href = data[\"redirect\"];\n        return;\n    }\n    const url = data[\"url\"];\n    if (!url) {\n        error(\"No URL in data \", data);\n        return;\n    }\n    log(\"Handling data\", data);\n    if (!onpopstate) {\n        if (lastLoaded.length === 1 && lastLoaded[0] === url) {\n            log(\"URL is the same as last loaded, ignoring\");\n            return;\n        }\n        history.pushState(\n            { data: data, url: url, stateType: \"dynLoad\" },\n            data[\"title\"],\n            url,\n        );\n        w.lastLocation = url;\n    }\n    if (!data[\"body\"]) {\n        w.location.reload();\n        return;\n    }\n\n    /* eslint-disable @typescript-eslint/no-empty-function */\n    // d.onkeyup = () => {}; // not used in any JS file\n    d.onkeydown = () => {}; // remove keydown listeners\n    /* eslint-enable @typescript-eslint/no-empty-function */\n\n    bodyDiv.innerHTML = data[\"body\"];\n    if (data[\"css\"]) {\n        const style = d.createElement(\"style\");\n        style.innerHTML = data[\"css\"];\n        bodyDiv.appendChild(style);\n    }\n    if (data[\"stylesheets\"]) {\n        for (const scriptURL of data[\"stylesheets\"]) {\n            const link = d.createElement(\"link\");\n            link.rel = \"stylesheet\";\n            link.type = \"text/css\";\n            link.href = scriptURL;\n            bodyDiv.appendChild(link);\n        }\n    }\n    if (data[\"scripts\"]) {\n        for (const script of data[\"scripts\"]) {\n            if (script[\"src\"]) {\n                const scriptElement = d.createElement(\"script\");\n                scriptElement.src = script[\"src\"];\n                bodyDiv.appendChild(scriptElement);\n            } else {\n                error(\"Script without src\", script);\n            }\n        }\n    }\n\n    if (w.hideSitePane) {\n        hideSitePane();\n    }\n\n    d.title = data[\"title\"];\n    const titleElement = elById(\"title\");\n    titleElement.setAttribute(\n        \"short_title\",\n        data[\"short_title\"] || data[\"title\"],\n    );\n    titleElement.innerText = data[\"title\"];\n\n    dynLoadReplaceAnchors();\n    w.urlData = data;\n    return true;\n}\n\nfunction dynLoadReplaceAnchors() {\n    for (const anchor of d.getElementsByTagName(\"A\")) {\n        dynLoadReplaceHrefOnAnchor(anchor);\n    }\n}\n\nfunction dynLoadReplaceHrefOnAnchor(anchor) {\n    if (anchor.hasAttribute(\"no-dynload\")) {\n        return;\n    }\n\n    dynLoadFixHref(anchor);\n}\n\nfunction dynLoadFixHref(anchor) {\n    if (anchor.target === \"_blank\") {\n        return;\n    }\n\n    const href = (\n        anchor.href.startsWith(\"/\")\n            ? (w.location.origin + anchor.href)\n            : anchor.href\n    )\n        .trim();\n\n    const hrefWithoutQuery = href.split(\"?\")[0];\n    if (\n        // link is to different domain\n        !href.startsWith(w.location.origin) ||\n        // link is to file, not HTML page\n        (\n            hrefWithoutQuery.split(\"/\").pop().includes(\".\") &&\n            // URLs to redirect page are HTML pages\n            hrefWithoutQuery !== (w.location.origin + \"/redirect\")\n        ) ||\n        // link is to /chat, which redirects to another page\n        hrefWithoutQuery === (w.location.origin + \"/chat\")\n    ) {\n        return;\n    }\n\n    if (\n        // URL to the same page, but with hash\n        href.startsWith(\"#\") ||\n        href.startsWith(w.location.href.split(\"#\")[0] + \"#\")\n    ) {\n        return;\n    }\n\n    // TODO: this is broken because of CSP\n    anchor.onclick = (e) => {\n        dynLoad(href);\n        e.preventDefault();\n    };\n}\n\nfunction dynLoad(url) {\n    log(\"Loading URL\", url);\n    history.replaceState( // save current scrollPos\n        {\n            data: w.urlData,\n            url: w.location.href,\n            scrollPos: [\n                d.documentElement.scrollLeft || d.body.scrollLeft,\n                d.documentElement.scrollTop || d.body.scrollTop,\n            ],\n            stateType: \"dynLoad\",\n        },\n        d.title,\n        w.location.href,\n    );\n    dynLoadSwitchToURL(url);\n}\n\nfunction dynLoadSwitchToURL(url, allowSameUrl = false) {\n    if (!allowSameUrl && url === w.location.href) {\n        log(\"URL is the same as current, just hide site pane\");\n        if (w.hideSitePane) {\n            hideSitePane();\n        }\n        return;\n    }\n    bodyDiv.prepend(\n        \"Laden... Wenn dies zu lange (Ã¼ber ein paar Sekunden) dauert, lade bitte die Seite neu.\",\n    );\n    get(url, \"\", (data) => dynLoadOnData(data, false), (error) => {\n        log(error);\n        if (url === w.location.href) {\n            w.location.reload();\n        } else {\n            w.location.href = url;\n        }\n    });\n}\n\nfunction dynLoadOnPopState(event) {\n    if (event.state) {\n        log(\"Popstate\", event.state);\n        if (!(event.state[\"data\"] && dynLoadOnData(event.state, true))) {\n            // when the data did not get handled properly\n            dynLoadSwitchToURL(event.state[\"url\"] || w.location.href, true);\n        }\n        if (event.state[\"scrollPos\"]) {\n            w.scrollTo(\n                event.state[\"scrollPos\"][0],\n                event.state[\"scrollPos\"][1],\n            );\n            return;\n        }\n    }\n    error(\"Couldn't handle state. \", event.state);\n    w.location.reload();\n}\n\nw.PopStateHandlers[\"dynLoad\"] = dynLoadOnPopState;\n\ndynLoadReplaceAnchors();\n// @license-end\n"],
  "mappings": "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",
  "names": ["data", "onpopstate", "url", "style", "scriptURL", "link", "script", "scriptElement", "titleElement", "anchor", "href", "hrefWithoutQuery", "e", "allowSameUrl", "error", "event"]
}
