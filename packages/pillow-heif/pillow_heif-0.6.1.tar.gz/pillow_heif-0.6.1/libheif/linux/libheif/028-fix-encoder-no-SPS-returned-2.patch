From 98b867ea575ecce7039458b71f2c320742489e30 Mon Sep 17 00:00:00 2001
From: Joachim Bauch <bauch@struktur.de>
Date: Tue, 14 Dec 2021 12:18:00 +0100
Subject: [PATCH] Return error if no SPS / no encoded width or height.

---
 libheif/heif_context.cc | 8 ++++++--
 1 file changed, 6 insertions(+), 2 deletions(-)

diff --git a/libheif/heif_context.cc b/libheif/heif_context.cc
index 871d7824..3eac29fc 100644
--- a/libheif/heif_context.cc
+++ b/libheif/heif_context.cc
@@ -1966,8 +1966,8 @@ Error HeifContext::encode_image_as_hevc(std::shared_ptr<HeifPixelImage> image,
                  err.message);
   }
 
-  int encoded_width = image->get_width(heif_channel_Y);
-  int encoded_height = image->get_height(heif_channel_Y);
+  int encoded_width = 0;
+  int encoded_height = 0;
 
   for (;;) {
     uint8_t* data;
@@ -2002,6 +2002,10 @@ Error HeifContext::encode_image_as_hevc(std::shared_ptr<HeifPixelImage> image,
     }
   }
 
+  if (!encoded_width || !encoded_height) {
+    return Error(heif_error_Encoder_plugin_error,
+                 heif_suberror_Invalid_image_size);
+  }
 
   // if image size was rounded up to even size, add a 'clap' box to crop the
   // padding border away
