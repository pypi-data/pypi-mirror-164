From 4795ba10abd233024d0536096182133fa06d9c3b Mon Sep 17 00:00:00 2001
From: Dirk Farin <dirk.farin@gmail.com>
Date: Fri, 7 May 2021 11:33:40 +0200
Subject: [PATCH] fix loading alpha image (do not convert to RGB) #495

---
 libheif/heif_context.cc | 6 +++---
 libheif/heif_context.h  | 6 ++++--
 2 files changed, 7 insertions(+), 5 deletions(-)

diff --git a/libheif/heif_context.cc b/libheif/heif_context.cc
index f208e578..2ee4635f 100644
--- a/libheif/heif_context.cc
+++ b/libheif/heif_context.cc
@@ -1044,7 +1044,7 @@ Error HeifContext::decode_image_user(heif_item_id ID,
 Error HeifContext::decode_image_planar(heif_item_id ID,
                                        std::shared_ptr<HeifPixelImage>& img,
                                        heif_colorspace out_colorspace,
-                                       const struct heif_decoding_options* options) const
+                                       const struct heif_decoding_options* options, bool alphaImage) const
 {
   std::string image_type = m_heif_file->get_item_type(ID);
 
@@ -1136,7 +1136,7 @@ Error HeifContext::decode_image_planar(heif_item_id ID,
                                          img->get_colorspace() :
                                          out_colorspace);
 
-    if (target_colorspace == heif_colorspace_YCbCr) {
+    if (!alphaImage && target_colorspace == heif_colorspace_YCbCr) {
       target_colorspace = heif_colorspace_RGB;
     }
 
@@ -1272,7 +1272,7 @@ Error HeifContext::decode_image_planar(heif_item_id ID,
     if (alpha_image) {
       std::shared_ptr<HeifPixelImage> alpha;
       Error err = decode_image_planar(alpha_image->get_id(), alpha,
-                                      heif_colorspace_undefined);
+                                      heif_colorspace_undefined, nullptr, true);
       if (err) {
         return err;
       }
diff --git a/libheif/heif_context.h b/libheif/heif_context.h
index 441435ce..503b39a7 100644
--- a/libheif/heif_context.h
+++ b/libheif/heif_context.h
@@ -91,7 +91,8 @@ namespace heif {
 
       ~Image();
 
-      void clear() {
+      void clear()
+      {
         m_thumbnails.clear();
         m_alpha_channel.reset();
         m_depth_channel.reset();
@@ -337,7 +338,8 @@ namespace heif {
 
     Error decode_image_planar(heif_item_id ID, std::shared_ptr<HeifPixelImage>& img,
                               heif_colorspace out_colorspace,
-                              const struct heif_decoding_options* options = nullptr) const;
+                              const struct heif_decoding_options* options = nullptr,
+                              bool alphaImage = false) const;
 
     std::string debug_dump_boxes() const;
 
