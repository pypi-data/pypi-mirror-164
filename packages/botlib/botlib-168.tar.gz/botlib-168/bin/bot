#!/usr/bin/env python3
# This file is placed in the Public Domain.
# pylint: disable=E1101,E0611,C0116,C0413,C0411,W0406


"shell"

import os
import readline
import sys
import termios


sys.path.insert(0, "lib")
sys.path.insert(0, os.getcwd())


from hdl import Client, Event, scan
from obj import Wd


from bot.irc import IRC
from bot.rss import Fetcher


from bot import bsc, dbg, irc, log, rss, tdo


Wd.workdir = os.path.expanduser("~/.bot")


scan(bsc)
scan(dbg)
scan(irc)
scan(log)
scan(rss)
scan(tdo)


class Console(Client):

    @staticmethod
    def handle(event):
        Client.handle(event)
        event.wait()

    def poll(self):
        event = Event()
        event.txt = input("> ")
        event.orig = repr(self)
        return event


    @staticmethod
    def raw(txt):
        print(txt)


def wrap(func):
    fds = sys.stdin.fileno()
    gotterm = True
    try:
        old = termios.tcgetattr(fds)
    except termios.error:
        gotterm = False
    readline.redisplay()
    try:
        func()
    except (EOFError, KeyboardInterrupt):
        print("")
    finally:
        if gotterm:
            termios.tcsetattr(fds, termios.TCSADRAIN, old)


def main():
    bot = IRC()
    bot.start()
    fetcher = Fetcher()
    fetcher.start()
    csl = Console()
    csl.start()
    csl.forever()


wrap(main)
